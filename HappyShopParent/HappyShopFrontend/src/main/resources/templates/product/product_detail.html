<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: page_head(${titlePage},'none')">
</head>
<body>

	<div class="container-fluid">
		<div th:replace="navigation :: header_menu"></div>
		<div th:replace="breadcrumb :: content"></div>

		<div class="row">

			<div class="col-sm">
				<div class="m-2">
					<img th:src="@{${product.getProductMainImagePath}}" th:index="${0}"
						class="img-fluid" id="mainImage" />
				</div>
				<div class="d-flex justify-content-center">
					<div class="m-2 border p-1">
						<img th:src="@{${product.getProductMainImagePath}}"
							th:index="${0}" class="image-thumbnail" height="50px" />
					</div>
					<th:block th:each="extraImage, status : ${product.images}">
						<div class="m-2 border p-1">
							<img class="image-thumbnail" th:index="${status.count}"
								th:src="@{${extraImage.getPathExtraImageProduct}}" height="50px" />
						</div>
					</th:block>
				</div>
			</div>

			<div class="col-sm">
				<div>
					<h4 class="fw-bold">[[${product.name}]]</h4>
				</div>

				<div style="font-size: 20px;">
					<p><b>Brand:</b> [[${product.brand.name}]]</p>
				</div>

				<div class="product_rating"
					th:productId="${product.id}">
					<input type="hidden" th:value="${product.average_rating}"
						th:id="avr_rating +  ${product.id}" /> <input type="hidden"
						th:value="${product.review_count}"
						th:id="review_count +  ${product.id}" /> 
					<div th:id="star_rating +${product.id}"></div>
				</div>

				<div class="d-flex flex-row" style="font-size: 20px;">
					<b class="me-2">Price: </b>
					<span th:replace="product/product_fragment :: showProductPrice"></span>
					<p class="ms-2" th:if="${product.discountPercent > 0}">
						([[${product.discountPercent}]]% off)</p>
				</div>
				

				<div>
					<p th:utext="${product.shortDescription}"></p>
				</div>

				<div class="">
					<div>
						<h5>
							Status:<span th:if="${product.inStock}" class="text-success">
								In Stock</span> <span th:unless="${product.inStock}"
								class="text-danger"> Out Of Stock</span>
						</h5>
					</div>

					<th:block th:if="${product.inStock}">
						<div class="mt-3"
							th:replace="cart/quantity_control :: content(1,${product.quantity},${product.id})">
						</div>

						<div class="mt-3 d-flex flex-row">
							<div>
								<input type="button" th:addToCartId="'a' + ${product.id}" class="btn btn-primary addToCart"
									value="Add To Cart" />
							</div>

							<div class="toast ms-3" id="addToCartToast" role="alert"
								aria-live="assertive" aria-atomic="true">
								<div class="toast-body text-success">
									<b> The items added to your cart. </b>
									<div class="mt-2 pt-2 border-top">
										<a th:href="@{/cart}" class="btn btn-primary ">Go to cart</a>
										<button type="button" class="btn btn-secondary "
											data-bs-dismiss="toast">Close</button>
									</div>
								</div>
							</div>
						</div>
					</th:block>
					
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<div>
					<hr />
				</div>
			</div>
			<div class="col-12">
				<h3>Product Descriptions</h3>
			</div>
			<div class="col-12">
				<p th:utext="${product.fullDescription}"></p>
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<div>
					<hr />
				</div>
			</div>
			<div class="col-12">
				<h3>Product Details</h3>
			</div>
			<div class="col-12">
				<th:block th:each="detail : ${product.details}">
					<p>
						<b>[[${detail.name}]]: </b> <span>[[${detail.value}]]</span>
					</p>
				</th:block>
			</div>
		</div>
		
		<div class="row">
			<div class="col-12">
				<div>
					<hr />
				</div>
			</div>
			<div class="col-12">
				<h3>Customer Reviews</h3>
			</div>
			<div class="col-12">
				<div th:id="customer_reviews + ${product.id}">
				</div>				
				<a href="" id="viewAllReviewsBtn" th:if="${product.review_count} != 0"><small>View all reviews</small></a>				
			</div>
		</div>
		
		<div class="mt-2 row">
			<h5>Most recent reviews</h5>
			<th:block th:each="review : ${recentReviews}">
				<div class="col-6"><hr /></div>			
				<div class="">
					<div th:id="review_star_by_customer + ${review.id}" th:reviewId="${review.id}" 
						class="customer_review" th:rating="${review.rating}"></div>
					<h6><strong>[[${review.headline}]]</strong></h6>
					<p>[[${review.comment}]]</p>
					<small>[[${review.customer.FullName}]]</small>
					<small class="ms-3" th:text="${#dates.format(review.reviewTime, 'yyyy-MM-dd')}"> </small>
				</div>	
			</th:block>		
		</div>

		<div class="modal" id="viewAllReviewsModal">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modal-title">All Reviews</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" id="modal-body">
						<div class="ratio ratio-4x3">
							<iframe th:src="@{'/review/all_reviews/page/1?productId=' + ${product.id}}" allowfullscreen></iframe>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<div th:replace="product/image_carousel :: content"></div>
		<div th:replace="navigation :: footer_menu"></div>
		<div th:replace="fragments :: footer"></div>
	</div>
	
	<script th:src="@{/js/product_rating.js}"></script>
	<script th:src="@{/js/product_rating_common.js}"></script>
	
	<script>
		$(document).ready(function(){
			$(".image-thumbnail").mouseenter(function(){
				currentIndexImage = $(this).attr("index");
				urlImageThumnail = $(this).attr("src");
				$("#mainImage").attr("src",urlImageThumnail);
				$("#mainImage").attr("index",currentIndexImage);
			});
			$("#mainImage").on("click", function(){
				$("#imageCarouselModal").modal("show");
				imageIndex = parseInt($("#mainImage").attr("index"));
				$("#imageCarouselModal").carousel(imageIndex);
			});
			
			$("#viewAllReviewsBtn").on("click", function(e){
				e.preventDefault();
				$("#viewAllReviewsModal").modal("show");
			});
			
		});
		
		contextPath = "[[@{/}]]";
		loginURL = "[[@{/login}]]";
		csrfHeaderName = "[[${_csrf.headerName}]]";
		csrfValue = "[[${_csrf.token}]]";
		
		$(".addToCart").on("click", function(){
			productIdString = $(this).attr("addToCartId");
			productId = parseInt(productIdString.substring(1, productIdString.length));
			quantity = parseInt($("#p" + productId).val());
			url = contextPath + "cart/add_to_cart/" + productId + "/"+ quantity;
			
			$.ajax({
				type: 'POST',
				url: url,
				beforeSend: function(xhr) {
					xhr.setRequestHeader(csrfHeaderName, csrfValue);
				},
			}).done(function(data) {
				if(data == "added the cart"){					
					$("#addToCartToast").toast('show');
				}
				else{
					location.replace(loginURL);
				}
			}).fail(function() {
				alert("fail");
			});
		});	
	</script>
	<script th:src="@{/js/cart_quantity_control.js}"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
		integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
		crossorigin="anonymous"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js"
		integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy"
		crossorigin="anonymous"></script>
		
</body>
</html>
